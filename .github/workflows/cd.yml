name: Review Visualizer Continious Deployment(CD)
on:
  workflow_run:
    workflows: ["Review Visualizer Continious Integration(CI)"]
    types:
      - completed
permissions:
  id-token: write
  contents: read
env: 
  ARTIFACTS_DOWNLOAD_PATH: "./artifact"
  CONNECTION_STRING: Server=tcp:${{ secrets.REVIEW_VISUALIZER_DB_SERVER_NAME }},1433;Initial Catalog=${{ secrets.PROD_DB_NAME }};User Id=${{ secrets.DB_LOGIN }};Password=${{ secrets.DB_PASSWORD }};Persist Security Info=False;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;
jobs:
  configure-database:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production
    runs-on: ubuntu-latest
    env:
      DATA_PROJECT_PATH: ReviewVisualizer.Data/ReviewVisualizer.Data.csproj
      STARTUP_PROJECT_PATH: ReviewVisualizer.WebApi/ReviewVisualizer.WebApi.csproj
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dotnet-ef
        run: dotnet tool install --global dotnet-ef
      
      - name: Apply EF Core migrations
        run: |
          dotnet ef database update --project $DATA_PROJECT_PATH \
          --startup-project $STARTUP_PROJECT_PATH \
          --connection "$CONNECTION_STRING"
  deploy:
    needs: configure-database
    environment: production
    strategy:
      matrix:
        project: ['Generator','WebApi']
    runs-on: ubuntu-latest
    steps:
        - name: Set env variables
          run: |
            echo "AZURE_WEBAPP_PACKAGE_PATH=ReviewVisualizer.${{ matrix.project }}/publish" >> $GITHUB_ENV
            echo "AZURE_WEBAPP_NAME=${{ matrix.project }}-App" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=${{ matrix.project }}-publish-artifacts" >> $GITHUB_ENV
        
        - name: Login to Azure
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
        - name: Download published project
          uses: actions/download-artifact@v4
          with:
            name: ${{ env.ARTIFACT_NAME }}
            run-id: ${{ github.event.workflow_run.id }}
            github-token: ${{ github.token }}
            path: ${{ env.ARTIFACTS_DOWNLOAD_PATH }}

        - name: Set environment variables for app service
          run: |
            az webapp config appsettings set \
            --name $AZURE_WEBAPP_NAME \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings ConnectionStrings__DefaultConnection="$CONNECTION_STRING" \
            CorsSettings__AllowedOrigins="${{ vars.ALLOWED_ORIGINS }}" \
            Admin__UserName=${{ secrets.REVIEW_VISUALIZER_ADMIN_USERNAME }} Admin__Password=${{ secrets.REVIEW_VISUALIZER_ADMIN_PASSWORD }} \
            DataProtection__Url="${{ secrets.BLOB_STORAGE_CONNECTIONSTRING }}" ImagesStorage__Url="${{ secrets.BLOB_STORAGE_CONNECTIONSTRING }}" \
            DataProtection__ContainerName="${{ secrets.DATA_PROTECTION_CONTAINER_NAME }}" \
            AuthCookieSettings__Domain="${{ vars.REVIEW_VISUALIZER_DOMAIN }}"
            AuthCookieSettings__SameSite=0
        
        - name: Run Azure webapp deploy action for ${{ matrix.project }}
          uses: azure/webapps-deploy@v3
          with: 
            app-name: ${{ env.AZURE_WEBAPP_NAME }}
            package: ${{ env.ARTIFACTS_DOWNLOAD_PATH }}
        
        - name: Azure Logout
          run: |
            az logout