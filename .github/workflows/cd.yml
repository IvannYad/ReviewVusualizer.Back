name: Review Visualizer Continious Deployment(CD)
on:
  workflow_run:
    workflows: ["Review Visualizer Continious Integration(CI)"]
    types:
      - completed
jobs:
  configure-database:
    runs-on: ubuntu-latest
    env:
      DATA_PROJECT_PATH: ReviewVisualizer.Data/ReviewVisualizer.Data.csproj
      STARTUP_PROJECT_PATH: ReviewVisualizer.WebApi/ReviewVisualizer.WebApi.csproj
      CONNECTION_STRING: Server=tcp:${{ secrets.REVIEW_VISUALIZER_SERVER_NAME }},1433;Initial Catalog=${{ secrets.PROD_DB_NAME }};User Id=${{ secrets.DB_LOGIN }};Password=${{ secrets.DB_PASSWORD }};Persist Security Info=False;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dotnet-ef
        run: dotnet tool install --global dotnet-ef
      
      - name: Apply EF Core migrations
        run: |
          dotnet ef database update --project $DATA_PROJECT_PATH \
          --startup-project $STARTUP_PROJECT_PATH \
          --connection "$CONNECTION_STRING"
  deploy:
    strategy:
      matrix:
        project: ['Generator','WebApi']
    runs-on: ubuntu-latest
    steps:
        - name: Set env variables
          run: |
            echo "AZURE_WEBAPP_PACKAGE_PATH=ReviewVisualizer.${{ matrix.project }}/publish" >> $GITHUB_ENV
            echo "AZURE_WEBAPP_NAME=${{ matrix.project }}-App" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=${{ matrix.project }}-publish-artifacts" >> $GITHUB_ENV
        
        - name: Login to Azure
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
        - name: Download published project
          uses: actions/download-artifact@v4
          with:
            name: ${{ env.ARTIFACT_NAME }}

        - name: Output contents
          run: ls

        # - name: Run Azure webapp deploy action for ${{ matrix.project }}
        #   uses: azure/webapps-deploy@v3
        #   with: 
        #     app-name: ${{ env.AZURE_WEBAPP_NAME }} # Replace with your app name
        #     package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}'
        
        - name: Azure Logout
          run: |
            az logout